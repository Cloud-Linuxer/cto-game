# LLM Event Quality Criteria

**EPIC-06 Feature 3: 품질 보증 시스템 구축**

LLM으로 생성된 동적 이벤트의 품질을 객관적으로 평가하기 위한 기준 문서입니다.

## 평가 목표

- **목표 점수**: 평균 80점 이상 (20개 샘플 기준)
- **평가 방식**: 4가지 차원 자동 평가 + 수동 리뷰
- **활용**: 생성 이벤트 필터링, 프롬프트 개선, 모델 성능 추적

---

## 평가 차원 (4가지)

### 1. Coherence (일관성) - 25%

**정의**: 이벤트 타입, 내용, 선택지 효과의 논리적 일치도

**평가 기준**:

| 항목 | 점수 | 평가 내용 |
|------|------|-----------|
| 이벤트 타입-내용 일치 | 25점 | CRISIS 타입이면 위기 키워드 포함, OPPORTUNITY 타입이면 기회 키워드 포함 |
| 이벤트 타입-효과 일치 | 15점 | CRISIS는 부정적 효과, OPPORTUNITY는 긍정적 효과 포함 |
| 게임 세계관 일치 | 20점 | 스타트업/AWS 컨텍스트 포함 (유저, 서비스, 투자, 매출 등) |
| 선택지 텍스트-효과 논리성 | 40점 | "투자"는 cash 감소, "절감"은 작은 효과, "공격적"은 큰 효과 |

**감점 요소**:
- CRISIS 타입인데 위기 키워드 없음: -25점
- CRISIS인데 모든 선택지가 긍정적: -15점
- OPPORTUNITY인데 모든 선택지가 부정적: -15점
- 스타트업 컨텍스트 부족: -20점
- 선택지 텍스트와 효과 불일치: -10점 (각 선택지당)

**예시**:
```
✅ 좋은 예:
- 타입: INFRASTRUCTURE_CRISIS
- 내용: "EC2 인스턴스에 장애가 발생했습니다."
- 효과: cashDelta: -30M, trustDelta: -5

❌ 나쁜 예:
- 타입: INFRASTRUCTURE_CRISIS
- 내용: "새로운 투자 기회가 생겼습니다."
- 효과: cashDelta: +50M, trustDelta: +10
```

---

### 2. Balance (밸런스) - 25%

**정의**: 게임 밸런스 내에서 효과의 적정성

**평가 기준**:

| 항목 | 점수 | 평가 내용 |
|------|------|-----------|
| Cash 효과 적정성 | 30점 | 평균 5M-80M 범위 (너무 크거나 작으면 감점) |
| User 효과 적정성 | 20점 | 평균 500-3000 범위 |
| Trust 효과 적정성 | 15점 | 평균 3-8 범위 |
| 선택지 간 밸런스 | 20점 | Cash 차이 <150M (한 선택지가 압도적이면 감점) |
| 게임오버 방지 | 15점 | 모든 선택지가 파산/신뢰도 0으로 이어지지 않음 |

**적정 범위**:
- **Cash**: -200M ~ +200M (평균 5M-80M)
- **Users**: -5K ~ +5K (평균 500-3000)
- **Trust**: -10 ~ +10 (평균 3-8)

**감점 요소**:
- 평균 cash > 80M: -25점 (너무 큼)
- 평균 cash < 5M: -15점 (너무 작음)
- 평균 user > 3K: -20점 (너무 큼)
- 평균 trust > 8: -15점 (너무 큼)
- 선택지 간 cash 차이 > 150M: -20점
- 모든 선택지가 파산: -30점
- 모든 선택지가 신뢰도 게임오버: -30점

**예시**:
```
✅ 좋은 예:
선택지 1: cash -50M, users +2000, trust +5
선택지 2: cash -10M, users +500, trust +3
→ 적정 범위 내, 선택지 간 밸런스 좋음

❌ 나쁜 예:
선택지 1: cash -500M, users +50K, trust +20
선택지 2: cash -400M, users +40K, trust +15
→ 모든 효과가 과도하게 큼
```

---

### 3. Entertainment (재미) - 25%

**정의**: 흥미로운 시나리오와 선택지 품질

**평가 기준**:

| 항목 | 점수 | 평가 내용 |
|------|------|-----------|
| 이벤트 텍스트 길이 | 25점 | 50-400자 범위 (너무 짧거나 길면 감점) |
| 제목 품질 | 10점 | 5-50자 범위 |
| 선택지 다양성 | 15점 | 3개 이상이면 보너스 +10점 |
| 선택지 텍스트 품질 | 30점 | 각 10-150자, 단순 답변("예"/"아니오") 감점 |
| 트레이드오프 존재 | 20점 | 선택지 간 의미 있는 차이 (한 선택지가 압도적이지 않음) |

**감점 요소**:
- 이벤트 텍스트 < 30자: -35점
- 이벤트 텍스트 30-50자: -15점
- 이벤트 텍스트 > 400자: -10점
- 선택지 텍스트 < 10자: -25점 (각 선택지당)
- 단순 답변("예"/"아니오"): -20점 (각 선택지당)
- 트레이드오프 없음: -20점

**보너스 요소**:
- 선택지 3개 이상: +10점
- 모든 선택지에 resultText 존재: +10점

**예시**:
```
✅ 좋은 예:
제목: "Aurora 데이터베이스 마이그레이션 제안" (20자)
내용: "현재 EC2의 MySQL이 한계에 도달했습니다. Aurora Serverless v2로 마이그레이션하면
      자동 스케일링과 고가용성을 확보할 수 있습니다. 다만 비용이 증가합니다." (90자)
선택지 1: "Aurora Serverless v2로 즉시 마이그레이션 (고가용성 확보)" (35자)
선택지 2: "EC2 인스턴스 스케일업으로 임시 대응" (23자)

❌ 나쁜 예:
제목: "문제" (2자)
내용: "상황 발생" (5자)
선택지 1: "예" (1자)
선택지 2: "아니오" (3자)
```

---

### 4. Educational (교육성) - 25%

**정의**: AWS 인프라 개념 학습 요소

**평가 기준**:

| 항목 | 점수 | 평가 내용 |
|------|------|-----------|
| 기본 점수 | 60점 | 모든 이벤트 기본 제공 |
| AWS 서비스 언급 | 40점 | 각 서비스당 +8점 (최대 40점) |
| 인프라 변경 효과 | 15점 | addInfrastructure 존재 시 보너스 |
| 아키텍처 개념 | 10점 | 스케일링, 가용성, 성능 등 2개 이상 포함 시 보너스 |
| FinOps 요소 | 5점 | 비용, 절감 등 언급 시 보너스 |

**AWS 서비스 목록** (각 +8점):
- EC2, S3, Lambda, RDS, Aurora
- EKS, CloudFront, Route53, VPC, DynamoDB
- ElastiCache, ALB, CloudWatch, IAM, KMS

**아키텍처 개념** (2개 이상 시 +10점):
- 스케일링, 확장성, 가용성, 내구성, 성능
- 최적화, 보안, 백업, 복구, 장애조치
- 다중화, 로드밸런싱, 캐싱, 모니터링

**예시**:
```
✅ 좋은 예:
내용: "EC2 인스턴스를 Aurora Serverless v2로 마이그레이션하면
      자동 스케일링과 고가용성을 확보할 수 있습니다.
      ElastiCache를 추가하면 성능 최적화도 가능합니다."
→ AWS 서비스 3개 (EC2, Aurora, ElastiCache) = +24점
→ 아키텍처 개념 3개 (스케일링, 가용성, 최적화) = +10점
→ 인프라 변경 = +15점
→ 총 60 + 24 + 10 + 15 = 109 → 100점 (상한)

❌ 나쁜 예:
내용: "서버를 업그레이드하면 성능이 개선됩니다."
→ AWS 서비스 언급 없음 = 0점
→ 총 60점
```

---

## 종합 점수 계산

**Overall Score** = (Coherence + Balance + Entertainment + Educational) / 4

**등급 기준**:
- **S (90-100)**: Excellent - 프로덕션 즉시 사용 가능
- **A (80-89)**: Good - 일부 개선 필요, 사용 가능
- **B (70-79)**: Fair - 개선 후 사용 권장
- **C (60-69)**: Poor - 상당한 개선 필요
- **D (0-59)**: Fail - 폐기 또는 전면 수정

**프로덕션 기준**:
- Overall ≥ 80점: 자동 승인
- Overall 60-79점: 수동 리뷰 후 결정
- Overall < 60점: 자동 폐기

---

## 품질 평가 프로세스

### 1. 자동 평가 (EventQualityScorer)

```typescript
import { EventQualityScorerService } from './event-quality-scorer.service';

const scorer = new EventQualityScorerService();
const score = scorer.calculateQualityScore(llmEvent, gameState);

if (score.overall >= 80) {
  // 자동 승인
  await saveEvent(llmEvent);
} else if (score.overall >= 60) {
  // 수동 리뷰 대기열
  await queueForManualReview(llmEvent, score);
} else {
  // 자동 폐기
  logger.warn(`Low quality event rejected: ${score.overall}/100`);
}
```

### 2. 수동 리뷰 (QA/Designer)

**리뷰 체크리스트**:
- [ ] 이벤트 내용이 게임 세계관에 적합한가?
- [ ] 선택지가 명확하고 이해하기 쉬운가?
- [ ] 효과가 게임 밸런스를 해치지 않는가?
- [ ] 플레이어가 흥미를 느낄 만한 시나리오인가?
- [ ] AWS 인프라 개념 학습 요소가 있는가?

**판정**:
- **승인**: 프로덕션 배포
- **수정 후 승인**: 프롬프트 수정 후 재생성
- **거부**: 폐기

---

## 품질 개선 전략

### Coherence 개선
1. 프롬프트에 이벤트 타입별 키워드 강제
2. Few-shot 예제에 일관성 좋은 샘플 추가
3. Validation에서 타입-내용 일치도 체크 강화

### Balance 개선
1. 효과 범위를 프롬프트에 명시적으로 제한
2. 게임 상태(cash, trust)를 고려한 동적 제약 생성
3. 선택지 간 효과 차이 제한 규칙 추가

### Entertainment 개선
1. 텍스트 길이 가이드라인 프롬프트 추가
2. 트레이드오프 예제 강화
3. resultText 생성 필수화

### Educational 개선
1. AWS 서비스 언급 최소 개수 설정 (프롬프트)
2. 인프라 변경 효과 우선 생성
3. 아키텍처 개념 용어집 제공

---

## 메트릭 추적

**수집 메트릭**:
- 일별 평균 품질 점수 (Overall, 각 차원)
- 등급별 분포 (S/A/B/C/D)
- 자동 승인율, 수동 리뷰율, 폐기율
- 차원별 평균 점수 추이

**목표 KPI**:
- Overall 평균 점수: ≥80점
- 자동 승인율: ≥70%
- 폐기율: ≤10%

---

**작성자**: Producer AI (EPIC-06 Feature 3)
**작성일**: 2026-02-05
**버전**: 1.0
